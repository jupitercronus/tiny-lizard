<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Details - the library sale</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }

        .navbar {
            background: #333;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: white;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .add-media-btn { background: #007bff; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: 600; transition: background-color 0.3s ease; }
        .add-media-btn:hover { background: #0056b3; }
        
        .auth-btn { 
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }

        .auth-btn:hover { 
            background: #c82333;
        }

        .main-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 30px 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .media-layout {
            display: flex;
            gap: 30px;
        }

        .media-poster {
            flex-shrink: 0;
            width: 250px;
        }

        .media-poster img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .no-poster {
            width: 250px;
            height: 375px;
            background: #f0f0f0;
            border: 2px dashed #ccc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: #999;
            text-align: center;
        }

        .media-info {
            flex-grow: 1;
        }

        .media-title {
            font-size: 2.8em;
            font-weight: bold;
            color: #333;
            margin: 0 0 10px 0;
        }
        
        .media-actions {
            margin-top: 20px;
        }
        
        .btn-action {
            padding: 8px 16px;
            border-radius: 5px;
            text-decoration: none;
            font-weight: 600;
            transition: background-color 0.3s ease;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn-add-list {
            background: #17a2b8;
            color: white;
        }

        .media-summary {
            margin-top: 20px;
            line-height: 1.6;
        }
        
        .section-divider {
            border: 0;
            height: 1px;
            background: #eee;
            margin: 30px 0;
        }
        
        .section-title {
            font-size: 1.8em;
            color: #333;
            margin-bottom: 20px;
        }

        .my-interaction-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }
        
        .star-rating {
            display: flex;
            gap: 3px;
            margin-bottom: 12px;
        }

        .star {
            color: #ffc107;
            font-size: 1.5em;
        }

        .star.empty {
            color: #ddd;
        }
        
        .btn-edit {
            background: #007bff;
            color: white;
        }
        .btn-edit:hover {
            background: #0056b3;
        }

        .physical-copies-list {
            list-style: none;
            padding: 0;
        }
        .physical-copy-item {
            background: #fff;
            border: 1px solid #eee;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .copy-owner a {
            color: #0056b3;
            text-decoration: none;
            font-weight: bold;
        }
        .copy-owner a:hover {
            text-decoration: underline;
        }
        
        .loading-state, .error-state {
            text-align: center;
            font-size: 1.2em;
            color: #666;
            padding: 50px 0;
        }
        
        /* Add to List Modal Styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); }
        .modal-content h3 { margin-top: 0; }
        #myListsContainer { max-height: 200px; overflow-y: auto; margin-bottom: 15px; border: 1px solid #eee; padding: 10px; }
        .list-choice { display: block; margin-bottom: 10px; }
        .modal-actions { text-align: right; }
        .btn-close { background: #6c757d; color: white; padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">the library sale</a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Library</a>
                <a href="lists.html" class="nav-link">Lists</a> 
                <a href="profile.html" class="nav-link">Profile</a>
                <a href="add-movie.html" class="add-media-btn">+ Add Media</a>
                <button id="authBtn" class="auth-btn">Login</button>
            </div>
        </div>
    </nav>

    <div class="main-container" id="mainContainer">
        <div class="loading-state">
            <h2>Loading Media Details...</h2>
        </div>
    </div>
    
    <!-- Add to List Modal -->
    <div id="addToListModal" class="modal">
        <div class="modal-content">
            <h3>Add to your lists</h3>
            <div id="myListsContainer">
                <!-- User's lists will be loaded here -->
            </div>
            <div class="modal-actions">
                <a href="create-list.html" style="float: left;">Create a new list</a>
                <button class="btn-close" onclick="closeAddToListModal()">Close</button>
            </div>
        </div>
    </div>


    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth();

        let currentUser = null;
        let mediaId = null;

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            mediaId = urlParams.get('id');
            if (!mediaId) {
                displayError("No media ID provided.");
                return;
            }

            auth.onAuthStateChanged(user => {
                currentUser = user;
                const authBtn = document.getElementById('authBtn');
                authBtn.textContent = user ? 'Logout' : 'Login';
                loadMediaData();
            });
            
            document.getElementById('authBtn').addEventListener('click', handleAuthButtonClick);
        });
        
        async function handleAuthButtonClick() {
            if (currentUser) {
                await auth.signOut();
                window.location.reload();
            } else {
                window.location.href = 'auth.html';
            }
        }

        async function loadMediaData() {
            try {
                const mediaDoc = await db.collection('movies').doc(mediaId).get();
                if (!mediaDoc.exists) {
                    displayError("Media not found in the database.");
                    return;
                }
                
                const [physicalCopiesSnapshot, interactionDoc] = await Promise.all([
                    db.collection('movies').doc(mediaId).collection('physicalCopies').get(),
                    currentUser ? db.collection('users').doc(currentUser.uid).collection('movieInteractions').doc(mediaId).get() : Promise.resolve(null)
                ]);

                const mediaData = mediaDoc.data();
                const myInteraction = interactionDoc && interactionDoc.exists ? interactionDoc.data() : null;
                
                const physicalCopies = [];
                physicalCopiesSnapshot.forEach(doc => {
                    physicalCopies.push(doc.data());
                });

                renderMediaPage(mediaData, myInteraction, physicalCopies);

            } catch (error) {
                console.error("Error loading media data:", error);
                displayError("An error occurred while loading the media data. Please try again.");
            }
        }

        function renderMediaPage(mediaData, myInteraction, physicalCopies) {
            const container = document.getElementById('mainContainer');
            const title = mediaData.title || mediaData.name || "Untitled";
            
            let myInteractionHTML = '';
            if (currentUser) {
                if (myInteraction) {
                    myInteractionHTML = `
                        <div class="my-interaction-section">
                            <h3 class="section-title">My Rating & Notes</h3>
                            <div class="star-rating">${generateStarDisplay(myInteraction.rating)}</div>
                            <p><strong>Status:</strong> ${myInteraction.watched ? 'Watched' : 'Not Watched'}</p>
                            ${myInteraction.watchedDate ? `<p><strong>Watched Date:</strong> ${myInteraction.watchedDate}</p>` : ''}
                            <p><strong>My Notes:</strong> ${myInteraction.review || '<em>No notes added.</em>'}</p>
                            <button class="btn-action btn-edit" onclick="editMyInteraction()">Edit My Details</button>
                        </div>
                    `;
                } else {
                     myInteractionHTML = `
                        <div class="my-interaction-section">
                            <h3 class="section-title">Add to Your Collection</h3>
                            <p>You haven't added this media to your personal collection yet.</p>
                            <button class="btn-action btn-edit" onclick="editMyInteraction()">Add Rating & Notes</button>
                        </div>
                    `;
                }
            }

            let physicalCopiesHTML = '';
            if (physicalCopies.length > 0) {
                const listItems = physicalCopies.map(copy => `
                    <li class="physical-copy-item">
                        <strong>${copy.editionDetails || 'Standard Edition'}</strong>
                        <span class="copy-owner">Owned by: <a href="profile.html?id=${copy.ownerId}">${copy.ownerDisplayName || 'Unknown'}</a></span>
                    </li>
                `).join('');
                physicalCopiesHTML = `
                    <div>
                        <h3 class="section-title">Physical Copies (${physicalCopies.length} total)</h3>
                        <ul class="physical-copies-list">${listItems}</ul>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="media-layout">
                    <div class="media-poster">
                        ${mediaData.posterUrl ? `<img src="${mediaData.posterUrl}" alt="${title} poster">` : '<div class="no-poster">No Poster</div>'}
                    </div>
                    <div class="media-info">
                        <h1 class="media-title">${title}</h1>
                        <div class="media-actions">
                            <button class="btn-action btn-add-list" onclick="openAddToListModal()">Add to a List...</button>
                        </div>
                        <div class="media-summary">
                            <p>${mediaData.overview || 'No summary available.'}</p>
                        </div>
                    </div>
                </div>
                <hr class="section-divider">
                ${myInteractionHTML}
                <hr class="section-divider">
                ${physicalCopiesHTML}
            `;
        }
        
        async function openAddToListModal() {
            if (!currentUser) {
                alert("Please log in to add this to a list.");
                return;
            }
            const modal = document.getElementById('addToListModal');
            const container = document.getElementById('myListsContainer');
            container.innerHTML = "<p>Loading your lists...</p>";
            modal.style.display = 'flex';

            try {
                const listsSnapshot = await db.collection('lists').where('creatorId', '==', currentUser.uid).get();
                if (listsSnapshot.empty) {
                    container.innerHTML = "<p>You haven't created any lists yet.</p>";
                    return;
                }

                container.innerHTML = listsSnapshot.docs.map(doc => {
                    const list = doc.data();
                    const listId = doc.id;
                    const alreadyAdded = (list.mediaIds || []).includes(mediaId);
                    return `
                        <div class="list-choice">
                            <button onclick="toggleMediaInList('${listId}', ${alreadyAdded})" ${alreadyAdded ? 'style="background: #28a745; color: white;"' : ''}>
                                ${alreadyAdded ? '✓ Added' : 'Add'}
                            </button>
                            <span>${list.listName}</span>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error("Error fetching user's lists:", error);
                container.innerHTML = "<p>Could not load your lists.</p>";
            }
        }

        function closeAddToListModal() {
            document.getElementById('addToListModal').style.display = 'none';
        }

        async function toggleMediaInList(listId, alreadyAdded) {
            const operation = alreadyAdded 
                ? firebase.firestore.FieldValue.arrayRemove(mediaId) 
                : firebase.firestore.FieldValue.arrayUnion(mediaId);
            
            try {
                await db.collection('lists').doc(listId).update({ mediaIds: operation });
                openAddToListModal(); 
            } catch (error) {
                console.error("Error updating list:", error);
                alert("Could not update the list. Please try again.");
            }
        }
        
        function generateStarDisplay(rating) {
            let stars = '';
            if (!rating || rating === 0) return '<em>Not rated</em>';
            for (let i = 1; i <= 5; i++) {
                stars += `<span class="star ${i > rating ? 'empty' : ''}">★</span>`;
            }
            return stars;
        }

        function editMyInteraction() {
            if (currentUser) {
                window.location.href = `add-movie.html?edit=${mediaId}`;
            }
        }

        function displayError(message) {
            const container = document.getElementById('mainContainer');
            container.innerHTML = `<div class="error-state"><h2>Error</h2><p>${message}</p></div>`;
        }
    </script>
</body>
</html>
