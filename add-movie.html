<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Media - the library sale</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- ZXing Barcode Scanner Library -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .navbar {
            background: #333;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 999;
            margin: -20px -20px 20px -20px;
            border-radius: 10px 10px 0 0;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: white;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }
        .nav-link.active { background: #007bff; }
        .nav-link:hover { background: rgba(255, 255, 255, 0.1); }
        
        .auth-btn {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }
        .auth-btn:hover { background: #c82333; }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 0;
        }
        
        h1, h3 { color: #333; }
        
        .form-group { margin-bottom: 20px; }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        input[readonly], textarea[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
            opacity: 0.8;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .btn {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #6c757d; cursor: not-allowed; }
        
        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
        
        .search-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .search-controls input { flex: 1; min-width: 200px; }
        
        .search-results {
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            background: white;
        }
        
        .search-result {
            border-bottom: 1px solid #eee;
            padding: 15px;
            cursor: pointer;
            display: flex;
            gap: 15px;
            align-items: flex-start;
            transition: background-color 0.3s ease;
            position: relative;
        }
        .search-result:hover { background: #e3f2fd; }
        .search-result-poster { width: 60px; height: 90px; object-fit: cover; border-radius: 4px; flex-shrink: 0; }
        .no-poster { width: 60px; height: 90px; background: #f0f0f0; border: 2px dashed #ccc; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999; text-align: center; flex-shrink: 0; }
        .search-result-info { flex: 1; }
        .search-result h4 { margin: 0 0 5px 0; color: #333; }
        .search-result p { margin: 0; color: #666; font-size: 14px; }
        
        .relevance-score {
            font-size: 0.6em;
            background: #28a745;
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            margin-left: 4px;
        }
        
        .star-rating { 
            display: inline-flex; 
            gap: 2px;
        }
        .star { 
            position: relative; 
            font-size: 2.5em; 
            color: #ddd; 
            cursor: pointer;
            user-select: none;
        }
        .star::before {
            content: '‚òÖ';
            position: absolute;
            top: 0;
            left: 0;
            color: #ffc107;
            width: 0%;
            overflow: hidden;
            transition: width 0.1s ease;
        }
        .star.half::before { width: 50%; }
        .star.full::before { width: 100%; }
        .star.hover-half::before { width: 50%; }
        .star.hover-full::before { width: 100%; }

        .status-message { padding: 10px; border-radius: 5px; margin: 10px 0; }
        .status-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .status-error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .status-info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }

        .scanner-container { text-align: center; margin-top: 15px; }
        .scanner-overlay { position: relative; display: inline-block; }
        @keyframes scan { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 25px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2); text-align: center; }
        .modal-content h3 { margin-top: 0; color: #333; }
        .modal-content p { margin-bottom: 20px; color: #666; }
        .modal-buttons { display: flex; justify-content: center; gap: 15px; }
        .modal-btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s ease; }
        .modal-btn.ok { background: #007bff; color: white; }
        .modal-btn.ok:hover { background: #0056b3; }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
     <nav class="navbar">
        <div class="nav-container">
             <a href="index.html" class="logo">the library sale</a>
                <div class="nav-links">
                    <a href="index.html" class="nav-link">Library</a>
                    <a href="lists.html" class="nav-link">Lists</a> 
                    <a href="profile.html" class="nav-link">Profile</a> 
                    <a href="add-movie.html" class="nav-link active">Add Media</a>
                    <button id="authBtn" class="auth-btn">Logout</button>
                </div>
            </div>
    </nav>

    <div class="container">
        <h1 id="formTitle">Add New Media</h1>
        
        <div class="search-section">
            <h3>üîç Search for Media</h3>
            <div class="search-controls">
                <input type="text" id="movieSearch" placeholder="Type title, actor, director...">
                <button type="button" id="searchBtn" class="btn">Search</button>
                <button type="button" id="cameraBtn" class="btn">Scan Barcode</button>
                <button type="button" id="manualBarcodeBtn" class="btn">Enter Barcode</button>
            </div>
            
            <div id="manualBarcodeInput" style="display: none; margin-bottom: 15px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="barcodeInput" placeholder="Enter 8-18 digit barcode" pattern="[0-9]{8,18}" maxlength="18">
                    <button type="button" id="lookupBarcodeBtn" class="btn">Lookup</button>
                    <button type="button" id="cancelBarcodeBtn" class="btn" style="background: #6c757d;">Cancel</button>
                    <div class="loading-spinner" id="barcodeSpinner"></div>
                </div>
                <small style="color: #666; display: block; margin-top: 5px;">UPC/EAN barcodes are typically 12-13 digits</small>
            </div>
            
            <div class="scanner-container" id="scannerContainer" style="display: none;">
                <div class="scanner-overlay">
                    <video id="video" autoplay muted style="width: 100%; max-width: 400px; height: 300px; border: 2px solid #007bff; border-radius: 5px; background: #000;"></video>
                </div>
                <p style="margin: 10px 0; color: #666;">Position barcode in camera view</p>
                <button type="button" id="stopScanBtn" class="btn">Stop Camera</button>
            </div>
            
            <div id="statusMessage"></div>
            <div id="searchResults"></div>
        </div>
        
        <hr>
        
        <h3>‚úèÔ∏è Media Details</h3>
        <form id="movieForm">
            <input type="hidden" id="editionDetailsInput">

            <div class="form-row">
                <div class="form-group">
                    <label for="title">Title *</label>
                    <input type="text" id="title" required readonly>
                </div>
                <div class="form-group">
                    <label for="year">Year</label>
                    <input type="number" id="year" min="1900" max="2030" readonly>
                </div>
            </div>
            
             <div class="form-row">
                <div class="form-group">
                    <label for="director">Director</label>
                    <input type="text" id="director" readonly>
                </div>
                <div class="form-group">
                    <label for="genre">Genre</label>
                    <input type="text" id="genre" readonly>
                </div>
            </div>

            <div class="form-group">
                <label for="summary">Summary</label>
                <textarea id="summary" rows="6" placeholder="Media summary from TMDb" readonly></textarea>
            </div>
            
            <div class="form-group">
                <label for="cast">Cast</label>
                <input type="text" id="cast" placeholder="e.g., Leonardo DiCaprio, Joseph Gordon-Levitt" readonly>
            </div>

            <div class="form-group">
                <label for="contentType">Content Type *</label>
                <select id="contentType" required>
                    <option value="movie">Movie</option>
                    <option value="tv">TV Show</option>
                </select>
            </div>

            <h3>‚úèÔ∏è My Rating & Notes</h3>
            <div class="form-group">
                <label>Rating</label>
                <div class="star-rating" id="starRating">
                    <span class="star">‚òÖ</span>
                    <span class="star">‚òÖ</span>
                    <span class="star">‚òÖ</span>
                    <span class="star">‚òÖ</span>
                    <span class="star">‚òÖ</span>
                </div>
            </div>
            
            <div class="form-group">
                <label for="review">Review/Notes</label>
                <textarea id="review" rows="4" placeholder="What did you think of this media?"></textarea>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="watchedCheckbox">Watched?</label>
                    <input type="checkbox" id="watchedCheckbox" style="width: auto; margin-top: 8px;">
                </div>
                <div class="form-group">
                    <label for="watchedDate">Watched Date (Optional)</label>
                    <input type="date" id="watchedDate">
                </div>
            </div>

            <div class="form-group">
                <label for="ownedCheckbox">I own a physical copy</label>
                <input type="checkbox" id="ownedCheckbox" style="width: auto; margin-top: 8px;">
            </div>
            <div class="form-group" id="editionDetailsGroup" style="display: none;">
                <label for="editionDetails">Edition Details (e.g., Collector's Edition, Blu-ray)</label>
                <input type="text" id="editionDetails" placeholder="Details from the box">
            </div>
            
            <button type="submit" class="btn" id="submitBtn">Add Media</button>
        </form>
    </div>

    <div id="alertModal" class="modal">
        <div class="modal-content">
            <h3 id="alertModalTitle">Alert</h3>
            <p id="alertModalMessage">Something happened.</p>
            <div class="modal-buttons">
                <button class="modal-btn ok" id="alertModalOk">OK</button>
            </div>
        </div>
    </div>

    <script>
        let currentRating = 0;
        let editingMovieId = null; 
        let currentUser = null; 
        let isPublicFieldsEditable = true;
        let codeReader = null;
        let videoInputDevices = [];
        let creditCache = new Map();
        let creditLookupTimeout;
        
        const TMDB_BASE_URL = '/api/tmdb';
        const UPC_BASE_URL = '/api/upc';
        const TMDB_IMAGE_BASE = 'https://image.tmdb.org/t/p/w500';

        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011",
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth(); 

        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged(user => {
                const authBtn = document.getElementById('authBtn');
                if (user) {
                    currentUser = user;
                    authBtn.textContent = 'Logout';
                    initializePage();
                } else {
                    authBtn.textContent = 'Login';
                    window.location.href = 'auth.html'; 
                }
            });
            document.getElementById('authBtn').addEventListener('click', handleAuthButtonClick);
        });

        async function handleAuthButtonClick() {
            if (currentUser) await auth.signOut();
            else window.location.href = 'auth.html';
        }

        function initializePage() {
            setupForm();
            setupSearch();
            setupStarRating();
            setupBarcodeScanner();
            checkEditMode();
            
            document.getElementById('ownedCheckbox').addEventListener('change', (e) => {
                document.getElementById('editionDetailsGroup').style.display = e.target.checked ? 'block' : 'none';
            });
        }

        function setupForm() {
            const form = document.getElementById('movieForm');
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                if (editingMovieId) {
                    updateMedia();
                } else {
                    addMedia();
                }
            });
        }
        
        async function updateHistory(collectionName, docId, mediaId, mediaData, userInteraction) {
            if (collectionName === 'watchHistory' && userInteraction.watched && userInteraction.watchedDate) {
                 await db.collection('watchHistory').doc(docId).set({
                    userId: currentUser.uid,
                    userDisplayName: currentUser.displayName || currentUser.email,
                    mediaId: mediaId,
                    mediaTitle: mediaData.title,
                    posterUrl: mediaData.posterUrl,
                    watchedDate: userInteraction.watchedDate,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                console.log("Updated watch history.");
            } else if (collectionName === 'purchaseHistory' && userInteraction.owned) {
                await db.collection('purchaseHistory').doc(docId).set({
                    userId: currentUser.uid,
                    userDisplayName: currentUser.displayName || currentUser.email,
                    mediaId: mediaId,
                    mediaTitle: mediaData.title,
                    posterUrl: mediaData.posterUrl,
                    editionDetails: document.getElementById('editionDetails').value || 'Physical Copy',
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }, { merge: true });
                console.log("Updated purchase history.");
            }
        }

        async function addMedia() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';

            try {
                const tmdbId = document.getElementById('movieForm').dataset.tmdbId;
                let movieDocRef;
                let mainMediaData;

                if (tmdbId) {
                    const existingQuery = await db.collection('movies').where('tmdbId', '==', parseInt(tmdbId)).limit(1).get();
                    if (!existingQuery.empty) {
                        movieDocRef = existingQuery.docs[0].ref;
                        mainMediaData = existingQuery.docs[0].data();
                    }
                }
                
                if (!movieDocRef) {
                    mainMediaData = {
                        title: document.getElementById('title').value,
                        year: document.getElementById('year').value ? parseInt(document.getElementById('year').value) : null,
                        director: document.getElementById('director').value,
                        genre: document.getElementById('genre').value,
                        posterUrl: document.getElementById('movieForm').dataset.posterUrl || null,
                        runtime: document.getElementById('movieForm').dataset.runtime || null,
                        tmdbId: tmdbId ? parseInt(tmdbId) : null,
                        overview: document.getElementById('summary').value,
                        cast: document.getElementById('cast').value.split(',').map(c => c.trim()),
                        contentType: document.getElementById('contentType').value,
                        dateAdded: firebase.firestore.FieldValue.serverTimestamp(),
                        originalUploaderId: currentUser.uid,
                        originalUploaderDisplayName: currentUser.displayName || currentUser.email,
                        isManualEntry: isPublicFieldsEditable
                    };
                    movieDocRef = await db.collection('movies').add(mainMediaData);
                }

                const userInteractionData = {
                    rating: currentRating,
                    review: document.getElementById('review').value,
                    watched: document.getElementById('watchedCheckbox').checked,
                    watchedDate: document.getElementById('watchedDate').value || null,
                    owned: document.getElementById('ownedCheckbox').checked,
                    interactionDate: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('users').doc(currentUser.uid).collection('movieInteractions').doc(movieDocRef.id).set(userInteractionData);

                const historyDocId = `${currentUser.uid}_${movieDocRef.id}`;
                await updateHistory('watchHistory', historyDocId, movieDocRef.id, mainMediaData, userInteractionData);
                await updateHistory('purchaseHistory', historyDocId, movieDocRef.id, mainMediaData, userInteractionData);

                if (userInteractionData.owned) {
                    const physicalCopyData = {
                        ownerId: currentUser.uid,
                        ownerDisplayName: currentUser.displayName || currentUser.email,
                        editionDetails: document.getElementById('editionDetails').value || document.getElementById('editionDetailsInput').value || 'Standard Edition',
                        dateAdded: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await movieDocRef.collection('physicalCopies').add(physicalCopyData);
                }

                showAlertModal('Success', 'Media added to the library!', () => {
                    window.location.href = `library.html?id=${movieDocRef.id}`;
                });

            } catch (error) {
                console.error("Error adding media:", error);
                showAlertModal('Error', 'Could not add media: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Media';
            }
        }
        
        async function updateMedia() {
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Updating...';

            try {
                const movieDocRef = db.collection('movies').doc(editingMovieId);
                const mediaDoc = await movieDocRef.get();
                const mainMediaData = mediaDoc.data();

                const userInteractionData = {
                    rating: currentRating,
                    review: document.getElementById('review').value,
                    watched: document.getElementById('watchedCheckbox').checked,
                    watchedDate: document.getElementById('watchedDate').value || null,
                    owned: document.getElementById('ownedCheckbox').checked,
                    interactionDate: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection('users').doc(currentUser.uid).collection('movieInteractions').doc(editingMovieId).set(userInteractionData, { merge: true });

                const historyDocId = `${currentUser.uid}_${editingMovieId}`;
                await updateHistory('watchHistory', historyDocId, editingMovieId, mainMediaData, userInteractionData);
                await updateHistory('purchaseHistory', historyDocId, editingMovieId, mainMediaData, userInteractionData);

                const ownedCheckbox = document.getElementById('ownedCheckbox');
                const physicalCopiesRef = movieDocRef.collection('physicalCopies');
                const myCopyQuery = await physicalCopiesRef.where('ownerId', '==', currentUser.uid).get();

                if (ownedCheckbox.checked && myCopyQuery.empty) {
                    const physicalCopyData = {
                        ownerId: currentUser.uid,
                        ownerDisplayName: currentUser.displayName || currentUser.email,
                        editionDetails: document.getElementById('editionDetails').value || 'Standard Edition',
                        dateAdded: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    await physicalCopiesRef.add(physicalCopyData);
                } else if (!ownedCheckbox.checked && !myCopyQuery.empty) {
                    for (const doc of myCopyQuery.docs) {
                        await doc.ref.delete();
                    }
                }

                showAlertModal('Success', 'Your details have been updated!', () => {
                    window.location.href = `library.html?id=${editingMovieId}`;
                });

            } catch (error) {
                console.error("Error updating media:", error);
                showAlertModal('Error', 'Could not update media: ' + error.message);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Update Media';
            }
        }

        async function checkEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            editingMovieId = urlParams.get('edit');
            if (!editingMovieId) {
                togglePublicFieldsReadonly(false);
                return;
            };

            document.getElementById('formTitle').textContent = 'Edit My Details';
            document.getElementById('submitBtn').textContent = 'Update Details';

            const mediaDoc = await db.collection('movies').doc(editingMovieId).get();
            const interactionDoc = await db.collection('users').doc(currentUser.uid).collection('movieInteractions').doc(editingMovieId).get();
            
            if (!mediaDoc.exists) {
                showAlertModal('Error', 'Media not found.');
                return;
            }

            const mediaData = mediaDoc.data();
            document.getElementById('title').value = mediaData.title || '';
            document.getElementById('year').value = mediaData.year || '';
            document.getElementById('director').value = mediaData.director || '';
            document.getElementById('genre').value = mediaData.genre || '';
            document.getElementById('summary').value = mediaData.overview || '';
            document.getElementById('cast').value = (mediaData.cast || []).join(', ');
            document.getElementById('contentType').value = mediaData.contentType || 'movie';
            togglePublicFieldsReadonly(true);

            if (interactionDoc.exists) {
                const interactionData = interactionDoc.data();
                currentRating = interactionData.rating || 0;
                updateStars();
                document.getElementById('review').value = interactionData.review || '';
                document.getElementById('watchedCheckbox').checked = interactionData.watched || false;
                document.getElementById('watchedDate').value = interactionData.watchedDate || '';
                document.getElementById('ownedCheckbox').checked = interactionData.owned || false;

                if (interactionData.owned) {
                    document.getElementById('editionDetailsGroup').style.display = 'block';
                    const myCopyQuery = await db.collection('movies').doc(editingMovieId).collection('physicalCopies').where('ownerId', '==', currentUser.uid).limit(1).get();
                    if (!myCopyQuery.empty) {
                        document.getElementById('editionDetails').value = myCopyQuery.docs[0].data().editionDetails || '';
                    }
                }
            }
        }
        
        function setupSearch() {
            const searchInput = document.getElementById('movieSearch');
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const query = searchInput.value.trim();
                if (query.length > 2) {
                    searchTimeout = setTimeout(() => performSearch(query), 300);
                } else {
                    document.getElementById('searchResults').innerHTML = '';
                }
            });
            document.getElementById('searchBtn').addEventListener('click', () => performSearch(searchInput.value.trim()));
        }

        // HYBRID SMART SEARCH IMPLEMENTATION (Option 2)
        function containsPersonName(query) {
            const namePatterns = /\b[A-Z][a-z]+ [A-Z][a-z]+\b/;
            return namePatterns.test(query);
        }

        function calculateRelevanceScore(item, query) {
            const keywords = query.toLowerCase().split(' ').filter(k => k.length > 2);
            const title = (item.title || item.name || '').toLowerCase();
            const overview = (item.overview || '').toLowerCase();
            let score = 0;

            keywords.forEach(keyword => {
                if (title === keyword) score += 100;
                if (title.startsWith(keyword)) score += 50;
                if (title.includes(keyword)) score += 20;
                if (overview.includes(keyword)) score += 5;
                
                const titleWords = title.split(' ');
                titleWords.forEach(word => {
                    if (word.startsWith(keyword) || keyword.startsWith(word)) {
                        score += 10;
                    }
                });
            });

            const releaseYear = parseInt((item.release_date || item.first_air_date || '').substring(0, 4));
            if (releaseYear > 2020) score += 5;
            if (releaseYear > 2015) score += 3;

            score += Math.min(item.popularity / 10, 20);
            score += (item.vote_average || 0) * 2;

            return score;
        }

        async function performSearch(query) {
            if (!query) return;
            showStatusMessage('Searching...', 'info');
            
            try {
                const searchUrl = `${TMDB_BASE_URL}/search/multi?query=${encodeURIComponent(query)}`;
                const response = await fetch(searchUrl);
                const data = await response.json();

                const results = data.results
                    .filter(item => item.media_type === 'movie' || item.media_type === 'tv')
                    .map(item => ({
                        ...item,
                        score: calculateRelevanceScore(item, query),
                        needsCreditBoost: containsPersonName(query)
                    }))
                    .sort((a, b) => b.score - a.score);

                displayResultsWithCreditLookup(results, query);
                showStatusMessage(`${results.length} results found.`, 'success');
            } catch (error) {
                console.error("Search error:", error);
                showStatusMessage('Search failed.', 'error');
            }
        }

        function displayResultsWithCreditLookup(results, originalQuery) {
            const resultsDiv = document.getElementById('searchResults');
            if (results.length === 0) {
                resultsDiv.innerHTML = '<p>No results found.</p>';
                return;
            }

            resultsDiv.innerHTML = results.slice(0, 10).map((item, index) => {
                const title = item.title || item.name;
                const year = (item.release_date || item.first_air_date || '').substring(0, 4);
                const type = item.media_type === 'tv' ? 'TV Show' : 'Movie';
                
                return `
                    <div class="search-result" 
                         onclick="selectMedia('${item.id}', '${item.media_type}')"
                         onmouseenter="boostScoreWithCredits(this, '${item.id}', '${item.media_type}', '${originalQuery}', ${index})"
                         data-original-score="${item.score}">
                        <img src="${item.poster_path ? TMDB_IMAGE_BASE + item.poster_path : ''}" 
                             class="search-result-poster" onerror="this.style.display='none'">
                        <div class="search-result-info">
                            <h4>${title} (${year}) 
                                <span style="font-size:0.7em; background:#007bff; color:white; padding: 2px 6px; border-radius: 4px;">${type}</span>
                                <span class="relevance-score">
                                    ${Math.round(item.score)}
                                </span>
                            </h4>
                            <p>${(item.overview || '').substring(0, 100)}...</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function boostScoreWithCredits(element, id, mediaType, originalQuery, index) {
            clearTimeout(creditLookupTimeout);
            
            const cacheKey = `${mediaType}-${id}`;
            if (creditCache.has(cacheKey)) {
                updateScoreDisplay(element, creditCache.get(cacheKey), originalQuery);
                return;
            }

            creditLookupTimeout = setTimeout(async () => {
                try {
                    const creditUrl = `${TMDB_BASE_URL}/${mediaType}/${id}?append_to_response=credits`;
                    const response = await fetch(creditUrl);
                    const data = await response.json();
                    
                    creditCache.set(cacheKey, data.credits);
                    updateScoreDisplay(element, data.credits, originalQuery);
                } catch (error) {
                    console.error('Credit lookup error:', error);
                }
            }, 300);
        }

        function updateScoreDisplay(element, credits, originalQuery) {
            const keywords = originalQuery.toLowerCase().split(' ').filter(k => k.length > 2);
            const originalScore = parseFloat(element.dataset.originalScore);
            let creditBoost = 0;

            if (credits) {
                const cast = (credits.cast || []).map(c => c.name.toLowerCase());
                const director = (credits.crew.find(c => c.job === 'Director')?.name || '').toLowerCase();
                
                keywords.forEach(keyword => {
                    if (director.includes(keyword)) creditBoost += 25;
                    if (cast.some(actor => actor.includes(keyword))) creditBoost += 15;
                });
            }

            const newScore = originalScore + creditBoost;
            const scoreElement = element.querySelector('.relevance-score');
            if (scoreElement) {
                scoreElement.textContent = Math.round(newScore);
                if (creditBoost > 0) {
                    scoreElement.style.background = '#dc3545';
                    element.style.order = -newScore;
                }
            }
        }

        async function selectMedia(id, type) {
            showStatusMessage('Loading details...', 'info');
            document.getElementById('searchResults').innerHTML = '';
            try {
                const response = await fetch(`${TMDB_BASE_URL}/${type}/${id}?append_to_response=credits`);
                const data = await response.json();

                document.getElementById('title').value = data.title || data.name;
                document.getElementById('year').value = (data.release_date || data.first_air_date || '').substring(0, 4);
                document.getElementById('summary').value = data.overview;
                document.getElementById('genre').value = data.genres.map(g => g.name).join(', ');
                document.getElementById('cast').value = data.credits.cast.slice(0, 5).map(c => c.name).join(', ');
                const director = data.credits.crew.find(c => c.job === 'Director');
                document.getElementById('director').value = director ? director.name : '';
                document.getElementById('contentType').value = type;
                
                document.getElementById('movieForm').dataset.tmdbId = data.id;
                document.getElementById('movieForm').dataset.posterUrl = data.poster_path ? TMDB_IMAGE_BASE + data.poster_path : '';
                document.getElementById('movieForm').dataset.runtime = data.runtime || (data.episode_run_time ? data.episode_run_time[0] : null);

                togglePublicFieldsReadonly(true);
                isPublicFieldsEditable = false;
                showStatusMessage('Media details loaded successfully!', 'success');
            } catch (error) {
                console.error("Error selecting media:", error);
                showStatusMessage('Could not load details.', 'error');
            }
        }
        
        function setupStarRating() {
            const ratingContainer = document.getElementById('starRating');
            const stars = Array.from(ratingContainer.children);

            ratingContainer.addEventListener('mousemove', e => {
                const rect = ratingContainer.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                const hoverValue = Math.round(percent * 5 * 2) / 2;
                
                stars.forEach((star, index) => {
                    star.classList.remove('hover-full', 'hover-half');
                    if (hoverValue > index + 0.5) {
                        star.classList.add('hover-full');
                    } else if (hoverValue > index) {
                        star.classList.add('hover-half');
                    }
                });
            });

            ratingContainer.addEventListener('mouseleave', () => {
                stars.forEach(star => {
                    star.classList.remove('hover-full', 'hover-half');
                });
                updateStars();
            });

            ratingContainer.addEventListener('click', e => {
                const rect = ratingContainer.getBoundingClientRect();
                const percent = (e.clientX - rect.left) / rect.width;
                currentRating = Math.round(percent * 5 * 2) / 2;
                updateStars();
            });
        }

        function updateStars() {
            const stars = Array.from(document.getElementById('starRating').children);
            stars.forEach((star, index) => {
                star.classList.remove('full', 'half');
                if (currentRating > index + 0.5) {
                    star.classList.add('full');
                } else if (currentRating > index) {
                    star.classList.add('half');
                }
            });
        }

        function togglePublicFieldsReadonly(isReadonly) {
             const fields = ['title', 'year', 'director', 'genre', 'summary', 'cast', 'contentType'];
             fields.forEach(id => {
                const el = document.getElementById(id);
                if (el.tagName === 'SELECT') {
                    el.disabled = isReadonly;
                } else {
                    el.readOnly = isReadonly;
                }
             });
        }

        function showAlertModal(title, message, onOk = () => {}) { 
            const modal = document.getElementById('alertModal');
            document.getElementById('alertModalTitle').textContent = title;
            document.getElementById('alertModalMessage').textContent = message;
            modal.style.display = 'flex';
            document.getElementById('alertModalOk').onclick = () => {
                modal.style.display = 'none';
                onOk();
            };
        }

        function showStatusMessage(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status-message status-${type}">${message}</div>`;
        }
        
        // COMPLETE BARCODE SCANNER IMPLEMENTATION WITH PROPER EVENT LISTENERS
        async function setupBarcodeScanner() {
            const cameraBtn = document.getElementById('cameraBtn');
            const manualBtn = document.getElementById('manualBarcodeBtn');
            const lookupBtn = document.getElementById('lookupBarcodeBtn');
            const cancelBtn = document.getElementById('cancelBarcodeBtn');
            const stopBtn = document.getElementById('stopScanBtn');
            const barcodeInput = document.getElementById('barcodeInput');
            
            // Set up manual barcode entry listeners
            manualBtn.addEventListener('click', showManualInput);
            lookupBtn.addEventListener('click', lookupManualBarcode);
            cancelBtn.addEventListener('click', hideManualInput);
            stopBtn.addEventListener('click', stopScanner);
            
            // Allow Enter key in manual input
            barcodeInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    lookupManualBarcode();
                }
            });

            // Input validation on typing
            barcodeInput.addEventListener('input', function(e) {
                const value = e.target.value;
                const isValid = /^\d{0,18}$/.test(value);
                if (!isValid) {
                    e.target.value = value.replace(/\D/g, '').slice(0, 18);
                }
                
                const lookupBtn = document.getElementById('lookupBarcodeBtn');
                lookupBtn.disabled = e.target.value.length < 8;
            });

            // Set up camera scanning
            cameraBtn.addEventListener('click', startScanner);

            try {
                if (typeof ZXing !== 'undefined' && ZXing.BrowserMultiFormatReader) {
                    codeReader = new ZXing.BrowserMultiFormatReader();
                    
                    try {
                        videoInputDevices = await codeReader.listVideoInputDevices();
                        if (videoInputDevices.length === 0) {
                            cameraBtn.disabled = true;
                            cameraBtn.textContent = 'No Camera';
                            console.log('No video input devices found');
                        } else {
                            console.log(`Found ${videoInputDevices.length} video input devices`);
                        }
                    } catch (deviceError) {
                        console.error('Error listing video devices:', deviceError);
                        cameraBtn.disabled = true;
                        cameraBtn.textContent = 'Camera Access Denied';
                    }
                } else {
                    console.error('ZXing library not loaded properly');
                    cameraBtn.disabled = true;
                    cameraBtn.textContent = 'Scanner N/A';
                }
            } catch (err) {
                console.error("Error setting up barcode scanner:", err);
                cameraBtn.disabled = true;
                cameraBtn.textContent = 'Scanner Error';
            }
        }

        function showManualInput() {
            const manualDiv = document.getElementById('manualBarcodeInput');
            const barcodeInput = document.getElementById('barcodeInput');
            const lookupBtn = document.getElementById('lookupBarcodeBtn');
            
            manualDiv.style.display = 'block';
            barcodeInput.value = '';
            barcodeInput.focus();
            lookupBtn.disabled = true;
        }

        function hideManualInput() {
            const manualDiv = document.getElementById('manualBarcodeInput');
            const barcodeInput = document.getElementById('barcodeInput');
            const spinner = document.getElementById('barcodeSpinner');
            
            manualDiv.style.display = 'none';
            barcodeInput.value = '';
            spinner.style.display = 'none';
        }

        function lookupManualBarcode() {
            const barcode = document.getElementById('barcodeInput').value.trim();
            const spinner = document.getElementById('barcodeSpinner');
            
            if (!barcode) {
                showStatusMessage('Please enter a barcode number.', 'error');
                return;
            }
            
            if (!/^\d{8,18}$/.test(barcode)) {
                showStatusMessage('Please enter a valid barcode (8-18 digits).', 'error');
                return;
            }
            
            spinner.style.display = 'block';
            lookupMovieByBarcode(barcode).finally(() => {
                hideManualInput();
            });
        }

        async function startScanner() {
            if (!codeReader || videoInputDevices.length === 0) {
                showStatusMessage('Camera not available.', 'error');
                return;
            }

            const scannerContainer = document.getElementById('scannerContainer');
            const videoElement = document.getElementById('video');
            
            try {
                scannerContainer.style.display = 'block';
                showStatusMessage('Starting camera...', 'info');
                
                const selectedDeviceId = videoInputDevices[0].deviceId;
                
                await codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
                    if (result) {
                        console.log('Barcode detected:', result.text);
                        showStatusMessage(`Barcode detected: ${result.text}`, 'success');
                        stopScanner();
                        lookupMovieByBarcode(result.text);
                    }
                    if (err && !(err instanceof ZXing.NotFoundException)) {
                        console.error('Scanner error:', err);
                    }
                });
                
                showStatusMessage('Camera ready. Position barcode in view.', 'info');
                
            } catch (error) {
                console.error('Error starting scanner:', error);
                if (error.name === 'NotAllowedError') {
                    showStatusMessage('Camera access denied. Please allow camera permissions.', 'error');
                } else if (error.name === 'NotFoundError') {
                    showStatusMessage('No camera found on this device.', 'error');
                } else {
                    showStatusMessage('Failed to start camera: ' + error.message, 'error');
                }
                stopScanner();
            }
        }

        function stopScanner() {
            if (codeReader) {
                codeReader.reset();
            }
            document.getElementById('scannerContainer').style.display = 'none';
            showStatusMessage('Camera stopped.', 'info');
        }

        async function lookupMovieByBarcode(barcode) {
            showStatusMessage(`Looking up barcode: ${barcode}...`, 'info');
            try {
                const upcResponse = await fetch(`${UPC_BASE_URL}?upc=${barcode}`);
                
                if (!upcResponse.ok) {
                    throw new Error(`UPC lookup failed: ${upcResponse.status} ${upcResponse.statusText}`);
                }
                
                const upcData = await upcResponse.json();

                if (!upcData.items || upcData.items.length === 0) {
                    showStatusMessage('No product found for this barcode.', 'error');
                    showAlertModal('Barcode Not Found', `No product found for barcode: ${barcode}. You can try entering the movie details manually.`);
                    return;
                }
                
                const product = upcData.items[0];
                const productName = product.title || product.description || 'Unknown Product';
                
                document.getElementById('editionDetailsInput').value = productName;
                if (document.getElementById('editionDetails')) {
                    document.getElementById('editionDetails').value = productName;
                }
                
                showStatusMessage(`Found: ${productName}. Searching for movie details...`, 'info');
                
                const movieTitle = extractMovieTitle(productName);
                if (movieTitle) {
                    await performSearch(movieTitle);
                } else {
                    showStatusMessage('Could not extract movie title from product name.', 'error');
                }

            } catch (error) {
                console.error('Barcode lookup error:', error);
                showStatusMessage('Barcode lookup failed.', 'error');
                showAlertModal('Lookup Error', `Failed to lookup barcode: ${error.message}`);
            }
        }

        function extractMovieTitle(productName) {
            let title = productName;
            title = title.replace(/\b(DVD|Blu-ray|4K|UHD|Digital|Copy|Widescreen|Full Screen|Special Edition|Collector's Edition)\b/gi, '');
            title = title.replace(/\s*\(.*?\)\s*/g, ' ').trim(); 
            title = title.replace(/\s*\[.*?\]\s*/g, ' ').trim();
            title = title.replace(/\s+/g, ' ').trim();
            return title.trim() || productName;
        }

        // Cache management
        function clearCreditCache() {
            creditCache.clear();
        }

    </script>
</body>
</html> 