<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - the library sale</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
        }

        .navbar {
            background: #333;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            font-size: 1.8em;
            font-weight: bold;
            color: white;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .nav-link.active {
            background: #007bff;
        }
        
        .add-media-btn { background: #007bff; color: white; padding: 10px 20px; border-radius: 5px; text-decoration: none; font-weight: 600; transition: background-color 0.3s ease; }
        .add-media-btn:hover { background: #0056b3; }
        
        .auth-btn { 
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: background-color 0.3s ease;
        }

        .auth-btn:hover { 
            background: #c82333;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .profile-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .profile-header h1 {
            font-size: 2.5em;
            color: #333;
            margin-bottom: 10px;
        }

        .profile-header p {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            border: 1px solid #eee;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .section-title {
            font-size: 1.8em;
            color: #333;
            margin-top: 40px;
            margin-bottom: 20px;
            text-align: center;
        }

        .media-list-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .media-list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
        }

        .media-list-item {
            text-align: center;
            text-decoration: none;
            color: inherit;
            display: block;
        }
        
        .media-list-item:hover .media-list-poster {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .media-list-poster {
            width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 10px;
        }
        
        .no-poster-small {
            width: 100%;
            padding-top: 150%; /* Aspect ratio 2:3 */
            position: relative;
            background: #f0f0f0;
            border-radius: 5px;
             margin-bottom: 10px;
        }
        
        .no-poster-small::after {
            content: 'No Poster';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #999;
        }

        .media-list-item p {
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
            word-wrap: break-word;
        }

        .empty-list {
            text-align: center;
            color: #888;
            padding: 20px;
            grid-column: 1 / -1; /* Span all columns */
        }
        
        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 15px;
            }
            .nav-links {
                gap: 15px;
            }
            .profile-header h1 {
                font-size: 2em;
            }
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            .media-list-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo">the library sale</a>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Library</a>
                <a href="lists.html" class="nav-link">Lists</a> 
                <a href="profile.html" class="nav-link active">Profile</a>
                <a href="add-movie.html" class="add-media-btn">+ Add Media</a> 
                <button id="authBtn" class="auth-btn">Logout</button>
            </div>
        </div>
    </nav>

    <div class="main-container">
        <div id="profileContainer">
            <div class="profile-section">
                <div class="profile-header">
                    <h1 id="profileDisplayName">Loading...</h1>
                    <p id="profileEmail"></p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalMediaCount">0</div>
                        <div class="stat-label">Total Media in Collection</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="watchedMediaCount">0</div>
                        <div class="stat-label">Watched</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="ownedMediaCount">0</div>
                        <div class="stat-label">Owned Physical Copies</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgRating">0.0</div>
                        <div class="stat-label">Average Rating</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalHours">0</div>
                        <div class="stat-label">Hours Watched</div>
                    </div>
                </div>
            </div>

            <h2 class="section-title">Watched Media</h2>
            <div class="media-list-section">
                <div id="watchedMediaList" class="media-list-grid">
                    <div class="empty-list">Loading watched media...</div>
                </div>
            </div>

            <h2 class="section-title">Owned Media</h2>
            <div class="media-list-section">
                <div id="ownedMediaList" class="media-list-grid">
                    <div class="empty-list">Loading owned media...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyDDW8LtwpYevdkD7Q-_CxJ23mMfi00P21M",
          authDomain: "tiny-lizard.firebaseapp.com",
          projectId: "tiny-lizard",
          storageBucket: "tiny-lizard.firebasestorage.app",
          messagingSenderId: "250872474692",
          appId: "1:250872474692:web:969e0b1302ae3cb4666011"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore(); 
        const auth = firebase.auth(); 

        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const profileUserId = urlParams.get('id');

            auth.onAuthStateChanged(user => {
                currentUser = user;
                const authBtn = document.getElementById('authBtn');
                authBtn.textContent = user ? 'Logout' : 'Login';

                if (profileUserId) {
                    // If a user ID is in the URL, load that user's profile.
                    loadProfileData(profileUserId);
                } else if (currentUser) {
                    // If no ID in URL, but user is logged in, load their own profile.
                    loadProfileData(currentUser.uid);
                } else {
                    // If no ID and not logged in, redirect to login.
                    window.location.href = 'auth.html';
                }
            });
            
            document.getElementById('authBtn').addEventListener('click', handleAuthButtonClick);
        });

        async function handleAuthButtonClick() {
            if (currentUser) {
                await auth.signOut();
            } else {
                window.location.href = 'auth.html';
            }
        }

        async function loadProfileData(userId) {
            try {
                // Fetch the profile user's public info
                const userDoc = await db.collection('users').doc(userId).get();
                if (!userDoc.exists) {
                    document.getElementById('profileContainer').innerHTML = '<h2>User profile not found.</h2>';
                    return;
                }
                const profileData = userDoc.data();
                document.getElementById('profileDisplayName').textContent = profileData.displayName || 'User';
                document.getElementById('profileEmail').textContent = profileData.email;

                // Fetch this user's interactions
                const interactionsSnapshot = await db.collection('users').doc(userId).collection('movieInteractions').get();
                const interactions = interactionsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (interactions.length === 0) {
                    calculateAndDisplayStats([]);
                    displayWatchedMedia([]);
                    displayOwnedMedia([]);
                    return;
                }

                const mediaIds = interactions.map(i => i.id);
                
                const mediaSnapshot = await db.collection('movies').where(firebase.firestore.FieldPath.documentId(), 'in', mediaIds).get();
                const allMoviesData = {};
                mediaSnapshot.forEach(doc => {
                    allMoviesData[doc.id] = doc.data();
                });

                const fullMediaDetails = interactions.map(interaction => {
                    const mediaData = allMoviesData[interaction.id];
                    return { ...interaction, ...mediaData };
                });

                calculateAndDisplayStats(fullMediaDetails);
                displayWatchedMedia(fullMediaDetails.filter(m => m.watched));
                displayOwnedMedia(fullMediaDetails.filter(m => m.owned));

            } catch (error) {
                console.error("Error loading profile data:", error);
                document.getElementById('profileContainer').innerHTML = '<h2>Error loading profile. Please try again.</h2>';
            }
        }

        function calculateAndDisplayStats(mediaItems) {
            document.getElementById('totalMediaCount').textContent = mediaItems.length;
            document.getElementById('watchedMediaCount').textContent = mediaItems.filter(item => item.watched).length;
            document.getElementById('ownedMediaCount').textContent = mediaItems.filter(item => item.owned).length;
            
            const ratedItems = mediaItems.filter(item => item.rating > 0);
            const avgRating = ratedItems.length > 0
                ? (ratedItems.reduce((sum, item) => sum + item.rating, 0) / ratedItems.length).toFixed(1)
                : '0.0';
            document.getElementById('avgRating').textContent = avgRating;
            
            const totalHours = Math.round(
                mediaItems
                    .filter(item => item.watched && item.runtime)
                    .reduce((sum, item) => sum + parseInt(item.runtime), 0) / 60
            );
            document.getElementById('totalHours').textContent = totalHours;
        }

        function displayWatchedMedia(watchedItems) {
            const container = document.getElementById('watchedMediaList');
            if (watchedItems.length === 0) {
                container.innerHTML = '<div class="empty-list">No watched media yet.</div>';
                return;
            }
            watchedItems.sort((a, b) => new Date(b.watchedDate) - new Date(a.watchedDate));
            container.innerHTML = watchedItems.map(item => renderMediaItem(item)).join('');
        }

        function displayOwnedMedia(ownedItems) {
            const container = document.getElementById('ownedMediaList');
            if (ownedItems.length === 0) {
                container.innerHTML = '<div class="empty-list">No owned media yet.</div>';
                return;
            }
            ownedItems.sort((a,b) => (a.title || '').localeCompare(b.title || ''));
            container.innerHTML = ownedItems.map(item => renderMediaItem(item)).join('');
        }
        
        function renderMediaItem(item) {
            const title = item.title || 'Untitled';
            const posterHTML = item.posterUrl 
                ? `<img src="${item.posterUrl}" alt="${title}" class="media-list-poster">`
                : `<div class="no-poster-small"></div>`;

            return `
                <a href="library.html?id=${item.id}" class="media-list-item">
                    ${posterHTML}
                    <p>${title}</p>
                </a>
            `;
        }
    </script>
</body>
</html>
